<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Siar Kota OS</title>
    
    <script>
        "use strict";
        
        var QWebChannel = function(transport, initCallback) {
            if (typeof transport !== "object" || typeof transport.send !== "function") {
                console.error("Bad QWebChannel transport", transport);
                return;
            }
            this.transport = transport;
            this.execCallbacks = {};
            this.execId = 0;
            this.execRequests = {};
            this.objects = {};
            this.propertyUpdateHandlers = {};

            var self = this;

            this.transport.onmessage = function(message) {
                var data = message.data;
                if (typeof data === "string") {
                    data = JSON.parse(data);
                }
                switch (data.type) {
                    case 0: self.handleSignal(data); break;
                    case 1: self.handleResponse(data); break;
                    case 2: self.handlePropertyUpdate(data); break;
                    case 10: self.handleResponse(data); break; // Support Init PyQt6
                    default: console.error("invalid message:", message.data); break;
                }
            };

            this.exec(function(data) {
                for (var objectName in data) {
                    var objectInfo = data[objectName];
                    self.objects[objectName] = new QObject(objectName, objectInfo, self);
                }
                if (initCallback) {
                    initCallback(self);
                }
            });
        };

        QWebChannel.prototype.exec = function(callback) {
            if (!callback) return;
            var requestId = this.execId++;
            this.execRequests[requestId] = callback;
            this.transport.send(JSON.stringify({ type: 3, id: requestId }));
        };

        QWebChannel.prototype.handleSignal = function(message) {
            var object = this.objects[message.object];
            if (object) {
                object.signalEmitted(message.signal, message.args);
            } else {
                console.warn("Unhandled signal:", message);
            }
        };

        QWebChannel.prototype.handleResponse = function(message) {
            if (!message.hasOwnProperty("id")) return;
            // ANTI CRASH: Cek apakah callback masih ada
            if (this.execRequests[message.id]) {
                this.execRequests[message.id](message.data);
                delete this.execRequests[message.id];
            }
        };

        QWebChannel.prototype.handlePropertyUpdate = function(message) {
            for (var i in message.data) {
                var data = message.data[i];
                var object = this.objects[data.object];
                if (object) {
                    object.propertyUpdate(data.signals, data.properties);
                }
            }
            this.exec(message.data);
        };

        var QObject = function(name, data, webChannel) {
            this.__id__ = name;
            this.__objectSignals__ = {};
            this.__propertyCache__ = {};
            var self = this;

            if (data.signals) {
                data.signals.forEach(function(signal) {
                    self.__objectSignals__[signal[0]] = self.createSignal(signal[0], signal[1]);
                    self[signal[0]] = self.__objectSignals__[signal[0]];
                });
            }

            if (data.properties) {
                data.properties.forEach(function(property) {
                    self.__propertyCache__[property[0]] = property[1];
                    Object.defineProperty(self, property[0], {
                        get: function() { return self.__propertyCache__[property[0]]; },
                        set: function(value) { self.__propertyCache__[property[0]] = value; },
                        enumerable: true
                    });
                });
            }

            if (data.methods) {
                data.methods.forEach(function(method) {
                    self[method[0]] = function() {
                        var args = [];
                        var callback;
                        for (var i = 0; i < arguments.length; i++) {
                            if (typeof arguments[i] === "function") callback = arguments[i];
                            else args.push(arguments[i]);
                        }
                        webChannel.exec({
                            "type": 6,
                            "object": self.__id__,
                            "method": method[0],
                            "args": args
                        }, function(response) {
                            if (response !== undefined && callback) {
                                callback(response);
                            }
                        });
                    };
                });
            }
        };

        QObject.prototype.createSignal = function(name, signature) {
            var signal = {
                connect: function(callback) {
                    if (typeof callback === "function") signal.listeners.push(callback);
                },
                disconnect: function(callback) {
                    var idx = signal.listeners.indexOf(callback);
                    if (idx !== -1) signal.listeners.splice(idx, 1);
                },
                listeners: []
            };
            return signal;
        };

        QObject.prototype.signalEmitted = function(name, args) {
            var signal = this.__objectSignals__[name];
            if (signal) {
                signal.listeners.forEach(function(listener) {
                    listener.apply(null, args);
                });
            }
        };

        QObject.prototype.propertyUpdate = function(signals, properties) {
            for (var propertyName in properties) {
                this.__propertyCache__[propertyName] = properties[propertyName];
            }
        };
    </script>

    <style>
        /* BAGIAN 2: DESAIN TAMPILAN */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; user-select: none; }
        body { 
            background: linear-gradient(135deg, #1e1e2f 0%, #0a0a12 100%); 
            color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
        }
        
        /* Header */
        header { 
            height: 70px; background: rgba(255, 255, 255, 0.05); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            display: flex; align-items: center; justify-content: space-between; padding: 0 40px; 
        }
        .logo { font-size: 1.5rem; font-weight: bold; letter-spacing: 2px; }
        
        /* Tombol OFF */
        .btn-off {
            background: #ff4444; color: white; border: none;
            padding: 10px 25px; border-radius: 30px;
            font-weight: bold; cursor: pointer; font-size: 1rem;
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
            transition: transform 0.2s;
        }
        .btn-off:active { transform: scale(0.95); background: #cc0000; }

        /* Grid Menu */
        main { 
            flex: 1; display: grid; grid-template-columns: repeat(3, 1fr); 
            gap: 30px; padding: 50px; align-content: center; 
        }
        .card { 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 20px; height: 200px; 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            transition: 0.3s; cursor: pointer; 
        }
        .card:hover { 
            background: rgba(255, 255, 255, 0.15); 
            transform: translateY(-8px); 
            border-color: #00ff88; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .card:active { transform: scale(0.95); }
        .icon { font-size: 3.5rem; margin-bottom: 15px; }
        h2 { font-size: 1.2rem; font-weight: 400; color: #ddd; }
    </style>
</head>
<body>

    <header>
        <div class="logo">SIAR KOTA <span style="color:#00ff88">OS</span></div>
        <div id="waktu" style="font-family: monospace; font-size: 1.2rem;">00:00:00</div>
        <button class="btn-off" onclick="matikanSistem()">POWER OFF</button>
    </header>

    <main>
        <div class="card" onclick="alert('Fitur Layanan Publik')"><div class="icon">üèõÔ∏è</div><h2>Layanan Publik</h2></div>
        <div class="card" onclick="alert('Fitur Data')"><div class="icon">üìä</div><h2>Data Statistik</h2></div>
        <div class="card" onclick="alert('Fitur Darurat')"><div class="icon">üöë</div><h2>Gawat Darurat</h2></div>
        <div class="card" onclick="alert('Fitur Peta')"><div class="icon">üó∫Ô∏è</div><h2>Peta Wilayah</h2></div>
        <div class="card" onclick="alert('Fitur Berita')"><div class="icon">üì∞</div><h2>Berita Kota</h2></div>
        <div class="card" onclick="alert('Fitur Setting')"><div class="icon">‚öôÔ∏è</div><h2>Pengaturan</h2></div>
    </main>

    <script>
        // 1. Jam Digital
        setInterval(() => { 
            document.getElementById('waktu').innerText = new Date().toLocaleTimeString(); 
        }, 1000);

        // 2. Sambungan ke Python
        var backendSiar = null;

        document.addEventListener("DOMContentLoaded", function () {
            // Tunggu sampai QtWebEngine siap menyuntikkan transportasi
            if (typeof qt !== 'undefined') {
                initJembatan();
            } else {
                window.addEventListener('load', initJembatan);
            }
        });

        function initJembatan() {
            try {
                new QWebChannel(qt.webChannelTransport, function (channel) {
                    // Berhasil Konek!
                    backendSiar = channel.objects.jembatan_sistem;
                    console.log("‚úÖ TERHUBUNG DENGAN OTAK PYTHON");
                });
            } catch (e) {
                console.error("Menunggu QtWebEngine...", e);
            }
        }

        // Fungsi yang dipanggil tombol merah
        function matikanSistem() {
            if (backendSiar) {
                backendSiar.terima_perintah("tutup_aplikasi");
            } else {
                // Coba inisialisasi ulang jika belum konek
                initJembatan();
                // Beri waktu sedikit
                setTimeout(() => {
                    if(backendSiar) backendSiar.terima_perintah("tutup_aplikasi");
                    else alert("Sistem sedang memuat... Coba lagi!");
                }, 100);
            }
        }
    </script>
</body>
</html>